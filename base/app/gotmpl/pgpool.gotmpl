# Generated by rancher-gen {{timestamp}}
# rancher-gen --config=/app/rancher-gen.conf --onetime && cat /etc/pgpool.conf

# - pgpool Connection Settings -

listen_addresses = '*'
port = 9999
socket_dir = '/tmp'
listen_backlog_multiplier = 2
serialize_accept = off

# - pgpool Communication Manager Connection Settings -

pcp_listen_addresses = '*'
pcp_port = 9898
pcp_socket_dir = '/tmp'

# - Backend Connection Settings -
{{$envDBLinks := env "DATABASE_SERVICE"}}{{$targets := split $envDBLinks ","}}{{$d := dict "ix" 0}}{{with service $envDBLinks}}{{range .Containers}}{{$ix := pluck "ix" $d | first}}
backend_hostname{{$ix}} = '{{.Address}}'
backend_port{{$ix}} = 5432
backend_weight{{$ix}} = 1
backend_data_directory{{$ix}} = '/var/lib/postgresql/data'
backend_flag{{$ix}} = 'ALLOW_TO_FAILOVER'
{{$inc := add $ix 1}}{{$_ := set $d "ix" $inc}}{{end}}{{end}}
# - Authentication -

enable_pool_hba = on
pool_passwd = 'pool_passwd'
authentication_timeout = 60

# - SSL Connections -

ssl = off
#ssl_key = './server.key'
#ssl_cert = './server.cert'
#ssl_ca_cert = ''
#ssl_ca_cert_dir = ''


#------------------------------------------------------------------------------
# POOLS
#------------------------------------------------------------------------------

# - Concurrent session and pool size -

num_init_children = 32
max_pool = 4

# - Life time -

child_life_time = 300
child_max_connections = 0
connection_life_time = 0
client_idle_limit = 0


#------------------------------------------------------------------------------
# LOGS
#------------------------------------------------------------------------------

# - Where to log -

log_destination = 'stderr'

# - What to log -

log_line_prefix = '%t: pid %p: '   # printf-style string to output at beginning of each log line.
log_connections = off
log_hostname = off
log_statement = off
log_per_node_statement = off
log_standby_delay = 'none'

# - Syslog specific -
# syslog_facility = 'LOCAL0'
# syslog_ident = 'pgpool'

# - Debug -

#log_error_verbosity = default
#client_min_messages = notice

#log_min_messages = warning

#------------------------------------------------------------------------------
# FILE LOCATIONS
#------------------------------------------------------------------------------

pid_file_name = '/tmp/pgpool.pid'
logdir = '/var/log/pgpool'


#------------------------------------------------------------------------------
# CONNECTION POOLING
#------------------------------------------------------------------------------

connection_cache = on
reset_query_list = 'ABORT; DISCARD ALL'

#------------------------------------------------------------------------------
# REPLICATION MODE
#------------------------------------------------------------------------------

replication_mode = off
replicate_select = off
insert_lock = on
lobj_lock_table = ''


# - Degenerate handling -
replication_stop_on_mismatch = off
failover_if_affected_tuples_mismatch = off


#------------------------------------------------------------------------------
# LOAD BALANCING MODE
#------------------------------------------------------------------------------

load_balance_mode = on
ignore_leading_white_space = on
white_function_list = ''
black_function_list = 'nextval,setval,nextval,setval'
database_redirect_preference_list = ''
app_name_redirect_preference_list = ''
allow_sql_comments = off

#------------------------------------------------------------------------------
# MASTER/SLAVE MODE
#------------------------------------------------------------------------------

master_slave_mode = on
master_slave_sub_mode = 'stream'

# - Streaming -
sr_check_period = {{env "STREAM_CHECK_PERIOD"}}
sr_check_user = '{{env "MANAGER_USERNAME"}}'
sr_check_password = '{{env "MANAGER_PASSWORD"}}'
sr_check_database = '{{env "DATABASE"}}'
delay_threshold = 0

# - Special commands -

follow_master_command = ''

#------------------------------------------------------------------------------
# HEALTH CHECK GLOBAL PARAMETERS
#------------------------------------------------------------------------------

health_check_period = {{env "HCHECK_PERIOD"}}
health_check_timeout = {{env "HCHECK_TIMEOUT"}}
health_check_user = '{{env "MANAGER_USERNAME"}}'
health_check_password = '{{env "MANAGER_PASSWORD"}}'
health_check_database = '{{env "DATABASE"}}'
health_check_max_retries = 0
health_check_retry_delay = 1
connect_timeout = 10000

#------------------------------------------------------------------------------
# FAILOVER AND FAILBACK
#------------------------------------------------------------------------------

failover_command = ''
failback_command = ''
fail_over_on_backend_error = on
search_primary_node_timeout = 300
#------------------------------------------------------------------------------
# ONLINE RECOVERY
#------------------------------------------------------------------------------

recovery_user = '{{env "MANAGER_USERNAME"}}'
recovery_password = '{{env "MANAGER_PASSWORD"}}'
recovery_1st_stage_command = ''
recovery_2nd_stage_command = ''
recovery_timeout = 90
client_idle_limit_in_recovery = 0


#------------------------------------------------------------------------------
# WATCHDOG
#------------------------------------------------------------------------------

# - Enabling -

use_watchdog = off

# -Connection to up stream servers -

trusted_servers = ''
ping_path = '/bin'

# - Watchdog communication Settings -

wd_hostname = ''
wd_port = 9000
wd_priority = 1
wd_authkey = ''
wd_ipc_socket_dir = '/tmp'

# - Virtual IP control Setting -

delegate_IP = ''
if_cmd_path = '/sbin'
if_up_cmd = 'ip addr add $_IP_$/24 dev eth0 label eth0:0'
if_down_cmd = 'ip addr del $_IP_$/24 dev eth0'
arping_path = '/usr/sbin'
arping_cmd = 'arping -U $_IP_$ -w 1'

# - Behavior on escalation Setting -

clear_memqcache_on_escalation = on
wd_escalation_command = ''
wd_de_escalation_command = ''

# - Watchdog consensus settings for failover -
failover_when_quorum_exists = on
failover_require_consensus = on
allow_multiple_failover_requests_from_node = off

# - Lifecheck Setting -

# -- common --

wd_monitoring_interfaces_list = ''
wd_lifecheck_method = 'heartbeat'
wd_interval = 10

# -- heartbeat mode --

wd_heartbeat_port = 9694
wd_heartbeat_keepalive = 2
wd_heartbeat_deadtime = 30
heartbeat_destination0 = 'host0_ip1'
heartbeat_destination_port0 = 9694
heartbeat_device0 = ''

# -- query mode --

wd_life_point = 3
wd_lifecheck_query = 'SELECT 1'
wd_lifecheck_dbname = 'template1'
wd_lifecheck_user = 'nobody'
wd_lifecheck_password = ''



#------------------------------------------------------------------------------
# OTHERS
#------------------------------------------------------------------------------
relcache_expire = 0
relcache_size = 256
check_temp_table = on
check_unlogged_table = on

#------------------------------------------------------------------------------
# IN MEMORY QUERY MEMORY CACHE
#------------------------------------------------------------------------------
memory_cache_enabled = on
memqcache_method = 'shmem'
memqcache_memcached_host = 'localhost'
memqcache_memcached_port = 11211
memqcache_total_size = 67108864
memqcache_max_num_cache = 1000000
memqcache_expire = 0
memqcache_auto_cache_invalidation = on
memqcache_maxcache = 409600
memqcache_cache_block_size = 1048576
memqcache_oiddir = '/var/log/pgpool/oiddir'
white_memqcache_table_list = ''
black_memqcache_table_list = ''